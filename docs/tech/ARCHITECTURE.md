# Architecture — eluno.org

> Reference document for understanding and replicating this project's technical design.

---

## 1. Overview

```
  Content (i18n/)  →  Build (scripts/)  →  Static site (dist/)  →  Cloudflare Pages
       JSON              Node.js               HTML/CSS/JS             eluno.org
```

The project is a static site generator specialized for multilingual books. JSON content files are transformed into HTML pages with glossary links, source provenance, and cross-language navigation.

Deploy is automatic: push to `main` → Cloudflare Pages builds and deploys.

---

## 2. Technology Stack

### Frontend

| Technology | Use |
|---|---|
| HTML5 | Semantic structure (generated by build) |
| SCSS/SASS | Modular styles via `@eluno/core` |
| Vanilla JavaScript | Theme toggle, glossary, search |
| Self-hosted fonts (woff2) | Cormorant Garamond, Spectral |

### Build System

| Technology | Use |
|---|---|
| Node.js 20+ | Runtime for all scripts |
| SASS | CSS compilation (`src/scss/` → `dist/css/`) |
| dotenv | Environment variables (`.env`) |

### Hosting

| Service | Use |
|---|---|
| Cloudflare Pages | Site hosting, auto-deploy from `main` |
| static.eluno.org | Audiobook MP3s (exceed CF Pages 25MB limit) |
| GitHub Actions | CI: lint, format, tests, build validation |

### AI and Media

| Technology | Use |
|---|---|
| Claude (Anthropic) | Writing pipeline, automated translation (EN → ES/PT) |
| Edge TTS (Microsoft) | Audiobook generation (free, via `node-edge-tts`) |

---

## 3. Directory Structure

```
eluno/
├── i18n/                      # Content
│   ├── en/                    #   English
│   │   ├── chapters/          #     16 chapter JSON files
│   │   ├── glossary.json      #     Glossary terms
│   │   ├── references.json    #     Bibliographic references
│   │   ├── ui.json            #     Interface strings
│   │   ├── media.json         #     Media URLs (audio, PDF)
│   │   └── about.json         #     About page content
│   ├── es/                    #   Spanish (same structure)
│   ├── pt/                    #   Portuguese (same structure)
│   └── provenance/            #   Source maps (chNN.json → lawofone.info URLs)
│
├── src/                       # Source files
│   ├── scss/                  #   Styles (modular SASS)
│   │   ├── main.scss          #     Entry point
│   │   ├── abstracts/         #     Variables, mixins
│   │   ├── base/              #     Reset, typography
│   │   ├── components/        #     Buttons, cards, glossary
│   │   ├── layout/            #     Header, sidebar, footer
│   │   ├── pages/             #     Page-specific styles
│   │   └── utilities/         #     Helpers
│   ├── js/                    #   JavaScript (theme, glossary, search)
│   ├── fonts/                 #   Self-hosted woff2 + font-face CSS
│   └── templates/             #   HTML partials
│
├── scripts/                   # Build and pipeline scripts
│   ├── build-v2.cjs           #   Main HTML generator
│   ├── build-pdf.cjs          #   PDF generation
│   ├── integrate-chapter.js   #   Copy workspace chapter → i18n/
│   ├── translate-chapter.js   #   Translate EN → ES/PT via Claude API
│   ├── validate-json.js       #   JSON structure validation
│   ├── validate-alignment.js  #   Cross-language term consistency
│   └── audiobook/             #   TTS extraction, generation, concat, tagging
│
├── writing/                   # Writing pipeline
│   ├── protocol/              #   Stable rules (voice, QA, source hierarchy)
│   ├── reference/             #   Book structure, thematic index
│   ├── chapters/              #   Per-chapter prompts (ch01-ch16)
│   └── tools/                 #   Pipeline utility scripts
│
├── ai/                        # AI methodology
│   ├── QUICK_START.md         #   How to run the writing pipeline
│   ├── METHODOLOGY.md         #   Editorial decisions and their rationale
│   ├── AI_WRITING_PROMPT.md   #   The system prompt used for writing
│   ├── SOURCES.md             #   Source material download links
│   └── README.md              #   Overview and entry point
│
├── docs/                      # Documentation
│   ├── tech/                  #   Architecture, development, deploy
│   ├── project/               #   Contributing, roadmap, status, TODO
│   ├── writing/               #   Book structure, pipeline docs
│   └── audiobook/             #   Audio generation guides
│
├── .claude/commands/          # Claude Code slash commands
│   ├── write/                 #   6-phase writing pipeline
│   ├── audiobook/             #   Audio generation commands
│   ├── project/               #   Project management
│   └── sanity/                #   CMS integration
│
├── static/                    # Files copied directly to dist/
│   ├── _headers               #   Cloudflare security headers
│   ├── _redirects             #   URL redirects
│   ├── favicon.svg            #   Site favicon
│   └── pdf/                   #   Pre-built PDFs (EN/ES/PT)
│
├── dist/                      # Build output (gitignored)
├── audiobook/                 # Generated audio files
├── workspace/                 # Drafts and sources (gitignored)
├── tests/                     # Unit tests
├── .github/workflows/         # CI configuration
├── PROMPT.md                  # Public writing prompt
├── CONTRIBUTING.md            # Points to docs/project/CONTRIBUTING.md
└── LICENSE                    # AGPL-3.0
```

---

## 4. Build Process

### `npm run build`

Runs `node scripts/build-v2.cjs && npm run sass:build`:

1. **Load content**: reads chapter JSON from `i18n/{en,es,pt}/chapters/`
2. **Resolve markup**: transforms `{term:keyword}` → glossary HTML, `{ref:category:id}` → reference links
3. **Inject provenance**: appends source citations from `i18n/provenance/chNN.json`
4. **Generate HTML**: one page per chapter per language → `dist/{lang}/chapters/{slug}.html`
5. **Copy static**: `static/` → `dist/` (headers, redirects, favicon, PDFs)
6. **Compile SASS**: `src/scss/main.scss` → `dist/css/main.css` (compressed)

### Content Format

Chapters are JSON with inline markup:

```json
{
  "id": "ch1",
  "number": 1,
  "numberText": "Chapter One",
  "title": "Cosmology and Genesis",
  "sections": [
    {
      "id": "ch1-infinite",
      "title": "The Infinite and the Awakening of Consciousness",
      "content": [
        { "type": "paragraph", "text": "The first known thing..." },
        { "type": "quote", "text": "Everything begins..." }
      ]
    }
  ]
}
```

Markup types: `{term:keyword}` (glossary link), `{ref:category:id}` (source reference).

### Environment Variables

The build reads from `.env` (see `.env.example`):

| Variable | Used by | Required |
|---|---|---|
| `SITE_URL` | build-v2.cjs | No (defaults to eluno.org) |
| `GA_ID` | build-v2.cjs | No (omit to disable analytics) |
| `GITHUB_REPO` | build-v2.cjs | No (omit to hide footer link) |
| `ANTHROPIC_API_KEY` | translate-chapter.js | For translations only |

---

## 5. CI/CD Pipeline

### Validation (`.github/workflows/validate.yml`)

Runs on push to `main` and on pull requests:

1. Install dependencies (`npm ci`)
2. Lint (`npm run lint`)
3. Format check (`npm run format:check`)
4. Validate JSON structure (`npm run test:json`)
5. Run tests (`npm test`)
6. Validate cross-language alignment (`npm run test:alignment`)
7. Build (`npm run build`)

### Deploy

Cloudflare Pages watches the `main` branch and auto-deploys. No wrangler CLI or deploy workflow needed — CF Pages pulls from GitHub directly.

---

## 6. Hosting Architecture

```
┌──────────────────────────────────────────────────────┐
│                 CLOUDFLARE PAGES                      │
│                   eluno.org                           │
├──────────────────────────────────────────────────────┤
│  Static HTML (48 pages = 16 chapters × 3 languages)  │
│  CSS, JS, fonts, favicons                            │
│  PDFs (pre-built, in static/pdf/)                    │
│  Security headers (static/_headers)                  │
│  Automatic SSL, CDN, Brotli compression              │
└────────────────────┬─────────────────────────────────┘
                     │ audio references
                     ▼
┌──────────────────────────────────────────────────────┐
│                 STATIC SERVER                         │
│              static.eluno.org                         │
├──────────────────────────────────────────────────────┤
│  MP3 audiobooks (51 files: 16 chapters × 3 langs     │
│  + 3 complete audiobooks)                            │
│  Reason: MP3s exceed CF Pages 25MB file limit        │
└──────────────────────────────────────────────────────┘
```

---

## 7. Security

| Measure | Implementation |
|---|---|
| HTTPS | Automatic via Cloudflare |
| X-Frame-Options: DENY | `static/_headers` |
| X-Content-Type-Options: nosniff | `static/_headers` |
| Referrer-Policy | strict-origin-when-cross-origin |
| Permissions-Policy | Camera, mic, geolocation denied |
| Secrets management | `.env` (gitignored), GitHub Secrets for CI |
| Cache headers | Immutable for fonts/css/js/pdf, no-cache for HTML |

---

## 8. npm Scripts

| Script | Command | Description |
|---|---|---|
| `dev` | sass:watch + live-server | Local development (port 4025) |
| `build` | build-v2.cjs + sass:build | Full site generation |
| `build:pdf` | build-pdf.cjs | PDF generation |
| `integrate` | integrate-chapter.js | Copy workspace chapter to i18n/ |
| `translate` | translate-chapter.js | Translate EN → ES/PT via Claude API |
| `test` | node --test tests/ | Run unit tests |
| `test:json` | validate-json.js | Validate chapter JSON structure |
| `test:alignment` | validate-alignment.js all | Cross-language term consistency |
| `lint` | eslint scripts/ | Lint JavaScript |
| `format` | prettier --write . | Format all files |
| `validate` | lint + format:check + test:json | Full validation (pre-commit) |
| `audio:*` | audiobook scripts | TTS extraction, generation, concat |

---

## 9. Replicating This Architecture

To use this architecture for a different project:

1. Fork the repo
2. Replace content in `i18n/` with your own
3. Modify `writing/protocol/` for your voice and rules
4. Edit the CONFIG object in `scripts/build-v2.cjs` (titles, languages, URLs)
5. Set up `.env` with your domain and API keys
6. Deploy to Cloudflare Pages (connect GitHub repo)

See [ai/QUICK_START.md](../../ai/QUICK_START.md) for the full writing pipeline.

---

*Last updated: February 23, 2026*
